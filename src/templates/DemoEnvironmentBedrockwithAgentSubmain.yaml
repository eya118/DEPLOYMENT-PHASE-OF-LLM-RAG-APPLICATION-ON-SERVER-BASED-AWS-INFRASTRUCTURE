AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: 'Serverless RAG Q&A app with Bedrock Agent created via Lambda with prompt override'

Parameters:
  EnvironmentName:
    Type: String
    Default: dev

  BedrockModelRegion:
    Type: String
    AllowedValues:
      - us-east-1
      - us-west-2
      - eu-central-1
      - ap-northeast-1
      - ap-southeast-1
    Default: us-west-2

Resources:

  AmazonBedrockExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: bedrock.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonBedrockFullAccess
      Policies:
        - PolicyName: AllowLambdaInvoke
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: "*"
        - PolicyName: AllowPassRole
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource: "*"

  CreateAgentLambdaFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: CreateBedrockAgentFunction
      Handler: create_agent.lambda_handler
      Runtime: python3.11
      CodeUri: ../functions/
      Timeout: 120
      MemorySize: 256
      Environment:
        Variables:
          AGENT_NAME: rag-bedrock-agent-v3
          MODEL_ID: arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/us.meta.llama3-1-8b-instruct-v1:0
          AGENT_ROLE_ARN: !GetAtt AmazonBedrockExecutionRole.Arn
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:CreateAgent
                - bedrock:CreateAgentAlias
                - bedrock:InvokeAgent
                - bedrock:UpdateAgent
                - bedrock:PrepareAgent
              Resource: "*"
            - Effect: Allow
              Action:
                - iam:PassRole
              Resource: "*"
      Events:
        ApiInvoke:
          Type: Api
          Properties:
            Path: /create-agent
            Method: POST

Outputs:
  CreateAgentLambdaFunction:
    Description: Lambda function to create a Bedrock Agent with prompt override
    Value: !Ref CreateAgentLambdaFunction
