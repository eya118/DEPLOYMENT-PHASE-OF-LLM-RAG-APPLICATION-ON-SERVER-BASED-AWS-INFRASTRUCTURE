version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.11
    commands:
      - echo "üîß Installing Python dependencies..."
      - pip install -r src/dependencies/requirements.txt -t .
      - echo "üìÅ Listing all files for verification:"
      - ls -R
      - echo "üì¶ Installing AWS SAM CLI..."
      - pip install aws-sam-cli

  build:
    commands:
      - echo "üöÄ Starting build phase..."
      - echo "‚úÖ AWS CLI version:"
      - aws --version

      - echo "üî® Running SAM build..."
      - sam build --template-file src/templates/DemoEnvironementBedrockMain.yaml

      - echo "üì¶ Packaging SAM application..."
      - sam package \
          --template-file .aws-sam/build/template.yaml --s3-bucket pipeline-bucket-2025  --output-template-file src/templates/packaged-template.yaml

      - echo "üèÅ Build phase completed."

  post_build:
    on-failure: ABORT
    commands:
      - echo " Deploying SAM application..."
      - STACK_NAME="demo-bedrock-main-stack-test"
      - |
        if sam deploy \
            --template-file src/templates/packaged-template.yaml \
            --stack-name "$STACK_NAME" \
            --capabilities CAPABILITY_NAMED_IAM \
            --region us-west-2 \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
                ExportNamePrefix=change_prefix \
                EnvironmentName=dev \
                AmazonOpenSearchCollectionName=demobedrockcollection \
                AmazonOpenSearchIndexName=demobedrockindex \
                BedrockModelRegion=us-west-2 \
                UserName=eya; then
          echo "‚úÖ Deployment complete."
        else
          echo "‚ùå Deployment failed. Deleting stack $STACK_NAME..."
          aws cloudformation delete-stack --stack-name "$STACK_NAME" --region us-west-2
          echo "Stack deletion triggered."
          exit 1
        fi



#
#version: 0.2 ye
#
#phases:
#  build:
#    commands:
#      - echo "Install python dependencies"
#      - python -m pip install --upgrade pip
#      - if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
#      # - echo "Run tests"
#      # - python -m pip install flake8 pytest
#      # - pytest